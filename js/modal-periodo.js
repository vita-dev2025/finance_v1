class ModalPeriodo {
    constructor(periodoId) {
        this.periodoId = periodoId;
        this.periodo = null;
        this.transacoes = [];
        this.init();
    }

    async init() {
        await this.carregarPeriodo();
        await this.carregarTransacoes();
        this.renderizar();
        this.configurarEventos();
    }

    async carregarPeriodo() {
        try {
            this.periodo = await database.getPeriodo(this.periodoId);
        } catch (error) {
            mostrarMensagem('Erro ao carregar per√≠odo', 'erro');
        }
    }

    async carregarTransacoes() {
        try {
            this.transacoes = await database.getTransacoesPorPeriodo(this.periodoId);
        } catch (error) {
            mostrarMensagem('Erro ao carregar transa√ß√µes', 'erro');
        }
    }

    renderizar() {
        const modal = document.getElementById('modalPeriodo');
        const status = this.obterStatusPeriodo(this.periodo);
        
        // Atualizar t√≠tulo
        document.getElementById('modalPeriodoTitulo').textContent = 
            `Transa√ß√µes do Per√≠odo ${this.periodo.nome_periodo} - ${status}`;

        // Renderizar transa√ß√µes
        this.renderizarTransacoes();

        // Mostrar modal
        modal.classList.remove('hidden');
        this.resetarScroll();
    }

    renderizarTransacoes() {
        const container = document.getElementById('listaTransacoes');
        
        if (this.transacoes.length === 0) {
            container.innerHTML = '<p class="mensagem alerta">Nenhuma transa√ß√£o encontrada para este per√≠odo.</p>';
            return;
        }

        container.innerHTML = this.transacoes.map(transacao => {
            const valorClass = transacao.tp_trans === 'ENTRADA' ? 'entrada' : 'saida';
            
            return `
                <div class="transacao-item">
                    <button class="btn-abrir" onclick="modalPeriodoAtual.abrirTransacao(${transacao.id})" title="Abrir transa√ß√£o">
                        üìã
                    </button>
                    <div class="transacao-info">
                        <strong>${transacao.nm_trans}</strong>
                        <small>${transacao.cat_trans}</small>
                    </div>
                    <div class="valor-transacao ${valorClass}">
                        ${formatarMoeda(transacao.valor_trans)}
                    </div>
                    <div class="status">
                        ${transacao.status_trans}
                    </div>
                </div>
            `;
        }).join('');
    }

    obterStatusPeriodo(periodo) {
        const hoje = new Date();
        const dtFechamento = new Date(periodo.dt_fechamento);
        
        return dtFechamento < hoje ? 'ENCERRADO' : 'ABERTO';
    }

    configurarEventos() {
        document.getElementById('btnNovaTransacao').onclick = () => this.novaTransacao();
        document.getElementById('btnFecharPeriodo').onclick = () => this.fechar();
    }

    abrirTransacao(transacaoId) {
        this.fechar();
        const modalTransacao = new ModalTransacao(transacaoId);
        modalTransacao.abrir();
    }

    novaTransacao() {
        const status = this.obterStatusPeriodo(this.periodo);
        if (status === 'ENCERRADO') {
            mostrarMensagem('N√£o √© poss√≠vel criar transa√ß√µes em per√≠odos encerrados', 'erro');
            return;
        }

        this.fechar();
        const modalRegistro = new ModalRegistro(this.periodoId);
        modalRegistro.abrir();
    }

    fechar() {
        const modal = document.getElementById('modalPeriodo');
        modal.classList.add('hidden');
        this.resetarScroll();
    }

    resetarScroll() {
        const modalBody = document.querySelector('#modalPeriodo .modal-body');
        if (modalBody) {
            modalBody.scrollTop = 0;
        }
    }
}

// Vari√°vel global para acessar a inst√¢ncia atual
let modalPeriodoAtual = null;

// Atualizar a fun√ß√£o global para abrir modal de per√≠odo
function abrirModalPeriodo(periodoId) {
    modalPeriodoAtual = new ModalPeriodo(periodoId);
}